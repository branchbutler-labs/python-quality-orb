name: Auto Label PRs

on:
  pull_request:
    types: [opened, edited, synchronize]
  pull_request_target:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-pr:
    name: Label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42

      - name: Determine labels
        id: labels
        run: |
          LABELS=""

          # Check file patterns and add appropriate labels
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # Commands
            if [[ "$file" == src/commands/* ]]; then
              LABELS="$LABELS,command"
            fi

            # Jobs
            if [[ "$file" == src/jobs/* ]]; then
              LABELS="$LABELS,job"
            fi

            # Executors
            if [[ "$file" == src/executors/* ]]; then
              LABELS="$LABELS,executor"
            fi

            # Documentation
            if [[ "$file" == *.md ]]; then
              LABELS="$LABELS,documentation"
            fi

            # CI/CD
            if [[ "$file" == .circleci/* ]] || [[ "$file" == .github/* ]]; then
              LABELS="$LABELS,ci/cd"
            fi

            # Tests
            if [[ "$file" == *test* ]] || [[ "$file" == test-integration/* ]]; then
              LABELS="$LABELS,testing"
            fi

            # Configuration
            if [[ "$file" == .pre-commit* ]] || [[ "$file" == .yamllint* ]]; then
              LABELS="$LABELS,configuration"
            fi
          done

          # Remove duplicates and leading comma
          LABELS=$(echo "$LABELS" | tr ',' '\n' | sort -u | grep -v '^$' | tr '\n' ',' | sed 's/,$//')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Get PR size
        id: size
        run: |
          ADDITIONS=${{ github.event.pull_request.additions }}
          DELETIONS=${{ github.event.pull_request.deletions }}
          TOTAL=$((ADDITIONS + DELETIONS))

          if [ $TOTAL -lt 10 ]; then
            SIZE="size/XS"
          elif [ $TOTAL -lt 50 ]; then
            SIZE="size/S"
          elif [ $TOTAL -lt 200 ]; then
            SIZE="size/M"
          elif [ $TOTAL -lt 500 ]; then
            SIZE="size/L"
          else
            SIZE="size/XL"
          fi

          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const typeLabels = '${{ steps.labels.outputs.labels }}'.split(',').filter(l => l);
            const sizeLabel = '${{ steps.size.outputs.size }}';
            const allLabels = [...typeLabels, sizeLabel];

            // Remove old size labels first
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const oldSizeLabels = currentLabels
              .filter(l => l.name.startsWith('size/'))
              .map(l => l.name);

            for (const label of oldSizeLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label,
                });
              } catch (e) {
                // Label might not exist
              }
            }

            // Add new labels
            if (allLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: allLabels,
              });
            }

            console.log(`Applied labels: ${allLabels.join(', ')}`);

  label-breaking-change:
    name: Check Breaking Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        id: breaking
        run: |
          # Check PR title and body for breaking change indicators
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"

          if echo "$TITLE" | grep -qi "breaking\|BREAKING"; then
            echo "is_breaking=true" >> $GITHUB_OUTPUT
          elif echo "$BODY" | grep -qi "breaking change\|BREAKING CHANGE"; then
            echo "is_breaking=true" >> $GITHUB_OUTPUT
          else
            # Check if any parameters were removed
            if git diff origin/main -- src/ | grep -q "^-.*type:"; then
              echo "is_breaking=true" >> $GITHUB_OUTPUT
            else
              echo "is_breaking=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Apply breaking change label
        if: steps.breaking.outputs.is_breaking == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['breaking-change', 'semver:major'],
            });
